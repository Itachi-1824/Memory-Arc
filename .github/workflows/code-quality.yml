name: Code Quality Check

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write

jobs:
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install jq
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy radon

      - name: Run linters
        id: lint
        continue-on-error: true
        run: |
          echo "=== Flake8 ===" > lint_output.txt
          flake8 . --count --statistics --max-line-length=100 >> lint_output.txt 2>&1 || true
          
          echo -e "\n=== Black ===" >> lint_output.txt
          black --check . >> lint_output.txt 2>&1 || true
          
          echo -e "\n=== isort ===" >> lint_output.txt
          isort --check-only . >> lint_output.txt 2>&1 || true
          
          echo -e "\n=== Complexity ===" >> lint_output.txt
          radon cc . -a -nb >> lint_output.txt 2>&1 || true

      - name: Get lint results
        id: results
        run: |
          LINT_OUTPUT=$(cat lint_output.txt)
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$LINT_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI Quality Analysis
        id: analysis
        run: |
          LINT_OUTPUT="${{ steps.results.outputs.output }}"
          
          # Gemini 2.0 Flash can handle full linting output
          LINT_OUTPUT_FULL="${LINT_OUTPUT:0:150000}"
          
          PROMPT="Comprehensive code quality analysis for Memory-Arc Python project.

          Complete Linting Results:
          ${LINT_OUTPUT_FULL}

          Provide detailed quality report:
          1. Overall Code Quality Score (1-10) with detailed justification
          2. Critical Issues (must fix before merge)
             - Security vulnerabilities
             - Logic errors
             - Breaking changes
          3. High Priority Issues
             - Code style violations
             - Complexity issues
             - Type safety problems
          4. Medium Priority Issues
             - Minor style inconsistencies
             - Documentation gaps
             - Optimization opportunities
          5. Code Complexity Analysis
             - Functions/classes with high cyclomatic complexity
             - Suggestions for refactoring
          6. Best Practices Violations
             - Python idioms not followed
             - Anti-patterns detected
          7. Actionable Recommendations
             - Prioritized list of fixes
             - Code examples for improvements
          8. Positive Highlights
             - Well-written code sections
             - Good practices observed

          Be thorough, specific with line numbers, and provide actionable guidance."

          ANALYSIS=$(curl -s -X POST "https://text.pollinations.ai/openai" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.POLLI_TOKEN }}" \
            -d @- <<EOF | jq -r '.choices[0].message.content // "Analysis unavailable"'
          {
            "model": "gemini-2.0-flash-exp",
            "messages": [{"role": "user", "content": $(echo "$PROMPT" | jq -Rs .)}],
            "temperature": 0.3,
            "max_tokens": 4000
          }
          EOF
          )

          echo "analysis<<EOFMARKER" >> $GITHUB_OUTPUT
          echo "$ANALYSIS" >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      - name: Post Quality Report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const analysis = process.env.ANALYSIS;
            const lintOutput = process.env.LINT_OUTPUT;
            
            const report = `## üìä Code Quality Report

            ${analysis}

            <details>
            <summary>üîç Detailed Linting Output</summary>

            \`\`\`
            ${lintOutput}
            \`\`\`

            </details>

            ---
            *Generated by AI Code Quality Assistant*
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
        env:
          ANALYSIS: ${{ steps.analysis.outputs.analysis }}
          LINT_OUTPUT: ${{ steps.results.outputs.output }}
